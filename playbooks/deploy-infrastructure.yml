---
# Full NetBox Deployment from Scratch
# This recreates the exact deployment that was tested and working

- name: NetBox Full Deployment
  hosts: localhost
  gather_facts: yes
  become: yes

  vars_files:
    - ../group_vars/all/network.yml
    - ../group_vars/all/containers.yml
    - ../group_vars/all/versions.yml
    - ../group_vars/all/vault.yml

  tasks:
    - name: Display deployment info
      debug:
        msg:
          - "Starting NetBox deployment on Proxmox VE 9.0"
          - "NetBox version: {{ netbox_version }}"
          - "PostgreSQL version: {{ postgresql_full_version }}"
          - "Valkey version: {{ valkey_version }}"

    - name: Verify Proxmox version
      shell: pveversion | grep 'pve-manager'
      register: pve_version
      changed_when: false

    - name: Display Proxmox version
      debug:
        var: pve_version.stdout

    - name: Install required packages
      apt:
        name:
          - bridge-utils
          - python3-proxmoxer
          - python3-requests
          - iptables-persistent
        state: present
        update_cache: yes

    - name: Configure sysctl for IP forwarding
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { name: 'net.ipv4.ip_forward', value: '1' }
        - { name: 'vm.overcommit_memory', value: '1' }
        - { name: 'net.ipv4.conf.all.rp_filter', value: '0' }

    - name: Check if backend bridge exists
      shell: ip link show {{ backend_network.name }}
      register: backend_check
      failed_when: false
      changed_when: false

    - name: Create backend bridge vmbr1
      shell: |
        brctl addbr {{ backend_network.name }}
        ip addr add {{ backend_network.gateway }}/24 dev {{ backend_network.name }}
        ip link set {{ backend_network.name }} up
      when: backend_check.rc != 0

    - name: Check if DMZ bridge exists
      shell: ip link show {{ dmz_network.name }}
      register: dmz_check
      failed_when: false
      changed_when: false

    - name: Create DMZ bridge vmbr2
      shell: |
        brctl addbr {{ dmz_network.name }}
        ip addr add {{ dmz_network.gateway }}/24 dev {{ dmz_network.name }}
        ip link set {{ dmz_network.name }} up
      when: dmz_check.rc != 0

    - name: Enable NAT for backend network
      iptables:
        table: nat
        chain: POSTROUTING
        source: "{{ backend_network.cidr }}"
        out_interface: "{{ external_network.name }}"
        jump: MASQUERADE
        comment: "NAT for backend network"

    - name: Enable NAT for DMZ network
      iptables:
        table: nat
        chain: POSTROUTING
        source: "{{ dmz_network.cidr }}"
        out_interface: "{{ external_network.name }}"
        jump: MASQUERADE
        comment: "NAT for DMZ network"

    - name: Save iptables rules
      shell: iptables-save > /etc/iptables/rules.v4
      changed_when: false

    - name: Display network status
      shell: brctl show
      register: bridges
      changed_when: false

    - name: Show configured bridges
      debug:
        var: bridges.stdout_lines

    - name: Check if Debian template exists
      stat:
        path: "/var/lib/vz/template/cache/{{ debian_template }}"
      register: template_check

    - name: Download Debian template
      command: pveam download local {{ debian_template }}
      when: not template_check.stat.exists

    - name: Display deployment message
      debug:
        msg: "Infrastructure ready. Manual container deployment recommended due to incomplete automation roles."

