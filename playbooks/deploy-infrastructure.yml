---
# Full NetBox Deployment from Scratch
# This recreates the exact deployment that was tested and working

- name: NetBox Full Deployment
  hosts: localhost
  gather_facts: true
  become: true

  vars_files:
    - ../group_vars/all/network.yml
    - ../group_vars/all/containers.yml
    - ../group_vars/all/versions.yml
    - ../group_vars/all/vault.yml

  tasks:
    - name: Display deployment info
      ansible.builtin.debug:
        msg:
          - "Starting NetBox deployment on Proxmox VE 9.0"
          - "NetBox version: {{ netbox_version }}"
          - "PostgreSQL version: {{ postgresql_full_version }}"
          - "Valkey version: {{ valkey_version }}"

    - name: Verify Proxmox version
      ansible.builtin.shell: pveversion | grep 'pve-manager'
      register: deploy_pve_version
      changed_when: false

    - name: Display Proxmox version
      ansible.builtin.debug:
        var: deploy_pve_version.stdout

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - bridge-utils
          - python3-proxmoxer
          - python3-requests
          - iptables-persistent
        state: present
        update_cache: true

    - name: Configure sysctl for IP forwarding
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: true
      loop:
        - { name: 'net.ipv4.ip_forward', value: '1' }
        - { name: 'vm.overcommit_memory', value: '1' }
        - { name: 'net.ipv4.conf.all.rp_filter', value: '0' }

    - name: Check if backend bridge exists
      ansible.builtin.shell: ip link show {{ backend_network.name }}
      register: deploy_backend_check
      failed_when: false
      changed_when: false

    - name: Create backend bridge vmbr1
      ansible.builtin.shell: |
        brctl addbr {{ backend_network.name }}
        ip addr add {{ backend_network.gateway }}/24 dev {{ backend_network.name }}
        ip link set {{ backend_network.name }} up
      when: deploy_backend_check.rc != 0
      changed_when: true

    - name: Check if DMZ bridge exists
      ansible.builtin.shell: ip link show {{ dmz_network.name }}
      register: deploy_dmz_check
      failed_when: false
      changed_when: false

    - name: Create DMZ bridge vmbr2
      ansible.builtin.shell: |
        brctl addbr {{ dmz_network.name }}
        ip addr add {{ dmz_network.gateway }}/24 dev {{ dmz_network.name }}
        ip link set {{ dmz_network.name }} up
      when: deploy_dmz_check.rc != 0
      changed_when: true

    - name: Enable NAT for backend network
      ansible.builtin.iptables:
        table: nat
        chain: POSTROUTING
        source: "{{ backend_network.cidr }}"
        out_interface: "{{ external_network.name }}"
        jump: MASQUERADE
        comment: "NAT for backend network"

    - name: Enable NAT for DMZ network
      ansible.builtin.iptables:
        table: nat
        chain: POSTROUTING
        source: "{{ dmz_network.cidr }}"
        out_interface: "{{ external_network.name }}"
        jump: MASQUERADE
        comment: "NAT for DMZ network"

    - name: Save iptables rules
      ansible.builtin.shell: iptables-save > /etc/iptables/rules.v4
      changed_when: false

    - name: Display network status
      ansible.builtin.shell: brctl show
      register: deploy_bridges
      changed_when: false

    - name: Show configured bridges
      ansible.builtin.debug:
        var: deploy_bridges.stdout_lines

    - name: Check if Debian template exists
      ansible.builtin.stat:
        path: "/var/lib/vz/template/cache/{{ debian_template }}"
      register: deploy_template_check

    - name: Download Debian template
      ansible.builtin.command: pveam download local {{ debian_template }}
      when: not deploy_template_check.stat.exists
      changed_when: true

    - name: Display deployment message
      ansible.builtin.debug:
        msg: "Infrastructure ready. Manual container deployment recommended due to incomplete automation roles."

