---
# NetBox on Proxmox VE 9.0 - Complete Deployment Playbook
# This playbook deploys NetBox from greenfield Proxmox to fully operational state

- name: Pre-flight checks
  hosts: localhost
  gather_facts: true
  become: true
  tags: [always]

  tasks:
    - name: Verify Proxmox VE version
      ansible.builtin.shell: pveversion | grep 'pve-manager'
      register: site_pve_version
      changed_when: false
      failed_when: "'pve-manager' not in site_pve_version.stdout"

    - name: Display Proxmox version
      ansible.builtin.debug:
        msg: "Running on {{ site_pve_version.stdout }}"

    - name: Check available resources
      ansible.builtin.shell: |
        free -m | awk 'NR==2{printf "Memory: %s/%sMB (%.2f%%)\n", $3,$2,$3*100/$2}'
        df -h | awk '$NF=="/"{printf "Disk: %d/%dGB (%s)\n", $3,$2,$5}'
      register: site_resources
      changed_when: false

    - name: Display available resources
      ansible.builtin.debug:
        var: site_resources.stdout_lines

# ==============================================================================
# PHASE 1: Proxmox Host Configuration
# ==============================================================================

- name: Configure Proxmox host
  hosts: localhost
  gather_facts: true
  become: true
  tags: [proxmox, host]

  roles:
    - role: proxmox_host

# ==============================================================================
# PHASE 2: Network Configuration
# ==============================================================================

- name: Configure network bridges and routing
  hosts: localhost
  gather_facts: true
  become: true
  tags: [proxmox, network]

  roles:
    - role: proxmox_network

  post_tasks:
    - name: Verify network bridges
      ansible.builtin.command: brctl show
      register: site_bridges
      changed_when: false

    - name: Display configured bridges
      ansible.builtin.debug:
        var: site_bridges.stdout_lines

# ==============================================================================
# PHASE 3: Container Creation (Skeleton)
# ==============================================================================

- name: Container creation phase
  hosts: localhost
  gather_facts: true
  become: true
  tags: [containers, create]

  tasks:
    - name: Check if template exists
      ansible.builtin.stat:
        path: "/var/lib/vz/template/cache/{{ debian_template }}"
      register: site_template_stat

    - name: Download Debian template if not present
      ansible.builtin.command: pveam download {{ proxmox_template_storage }} {{ debian_template }}
      when: not site_template_stat.stat.exists
      changed_when: true

    - name: Create containers
      ansible.builtin.include_role:
        name: proxmox_container
      vars:
        container: "{{ item.value }}"
      loop: "{{ containers | dict2items }}"
      loop_control:
        label: "{{ item.value.hostname }}"

# ==============================================================================
# PHASE 4: Configure Database Container (CT 101)
# ==============================================================================

- name: Configure PostgreSQL database container
  hosts: ct101
  gather_facts: true
  become: true
  tags: [database]

  roles:
    - role: debian_base
    - role: postgresql

# ==============================================================================
# PHASE 5: Configure Cache Container (CT 102)
# ==============================================================================

- name: Configure Valkey cache container
  hosts: ct102
  gather_facts: true
  become: true
  tags: [cache]

  roles:
    - role: debian_base
    - role: valkey

# ==============================================================================
# PHASE 6: Configure NetBox Application Container (CT 100)
# ==============================================================================

- name: Configure NetBox application container
  hosts: ct100
  gather_facts: true
  become: true
  tags: [netbox]

  roles:
    - role: debian_base
    - role: netbox_app

# ==============================================================================
# PHASE 7: Configure Nginx Proxy Container (CT 103)
# ==============================================================================

- name: Configure Nginx reverse proxy container
  hosts: ct103
  gather_facts: true
  become: true
  tags: [proxy]

  roles:
    - role: debian_base
    - role: nginx_proxy

# ==============================================================================
# PHASE 8: Post-Deployment Verification
# ==============================================================================

- name: Post-deployment verification
  hosts: localhost
  gather_facts: false
  become: true
  tags: [always, verify]

  tasks:
    - name: Wait for all services to stabilize
      ansible.builtin.wait_for:
        timeout: 15

    - name: Check container status
      ansible.builtin.command: pct list
      register: site_container_list
      changed_when: false

    - name: Display container status
      ansible.builtin.debug:
        var: site_container_list.stdout_lines

    - name: Verify PostgreSQL service
      ansible.builtin.command: pct exec 101 -- systemctl is-active postgresql
      register: site_pg_status
      changed_when: false
      failed_when: false

    - name: Verify NetBox service
      ansible.builtin.command: pct exec 100 -- systemctl is-active netbox
      register: site_netbox_status
      changed_when: false
      failed_when: false

    - name: Verify Nginx service
      ansible.builtin.command: pct exec 103 -- systemctl is-active nginx
      register: site_nginx_status
      changed_when: false
      failed_when: false

    - name: Get proxy container external IP
      ansible.builtin.shell: >
        pct exec 103 -- ip -4 addr show eth0 | grep inet | awk '{print $2}' | cut -d/ -f1
      register: site_proxy_ip
      changed_when: false
      failed_when: false

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "============================================="
          - "  NetBox Deployment Complete!"
          - "============================================="
          - ""
          - "Services Status:"
          - "  PostgreSQL: {{ site_pg_status.stdout | default('unknown') }}"
          - "  NetBox:     {{ site_netbox_status.stdout | default('unknown') }}"
          - "  Nginx:      {{ site_nginx_status.stdout | default('unknown') }}"
          - ""
          - "Access Information:"
          - "  URL:      https://{{ site_proxy_ip.stdout | default('IP-not-found') }}"
          - "  Username: admin"
          - "  Password: {{ vault_netbox_admin_password }}"
          - ""
          - "Note: Using self-signed SSL certificate"
          - "      Your browser will show a security warning"
          - ""
          - "Next Steps:"
          - "  1. Access the web interface"
          - "  2. Change admin password"
          - "  3. Configure backup jobs"
          - "  4. Replace with valid SSL certificate"
          - "============================================="
