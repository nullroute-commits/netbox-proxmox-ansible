---
- name: Complete NetBox Deployment - Nginx Configuration
  hosts: localhost
  gather_facts: true
  become: true

  tasks:
    - name: Install Nginx on proxy container
      ansible.builtin.command: pct exec 103 -- apt update
      changed_when: false

    - name: Install Nginx package
      ansible.builtin.command: pct exec 103 -- apt install -y nginx openssl
      register: complete_nginx_install
      changed_when: "'0 newly installed' not in complete_nginx_install.stdout"

    - name: Create SSL directory
      ansible.builtin.command: pct exec 103 -- mkdir -p /etc/nginx/ssl
      changed_when: false

    - name: Generate self-signed SSL certificate
      ansible.builtin.command: >
        pct exec 103 -- openssl req -x509 -nodes -days 365 -newkey rsa:4096
        -keyout /etc/nginx/ssl/netbox.key
        -out /etc/nginx/ssl/netbox.crt
        -subj "/C=US/ST=State/L=City/O=Organization/CN=netbox.local"
      args:
        creates: /var/lib/lxc/103/rootfs/etc/nginx/ssl/netbox.crt

    - name: Create Nginx site configuration
      ansible.builtin.shell: |
        pct exec 103 -- bash -c 'cat > /etc/nginx/sites-available/netbox << "EOF"
        upstream netbox {
            server 10.100.1.10:8000;
        }

        server {
            listen 80;
            server_name _;
            return 301 https://$host$request_uri;
        }

        server {
            listen 443 ssl http2;
            server_name _;

            ssl_certificate /etc/nginx/ssl/netbox.crt;
            ssl_certificate_key /etc/nginx/ssl/netbox.key;

            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_ciphers HIGH:!aNULL:!MD5;
            ssl_prefer_server_ciphers on;

            client_max_body_size 25m;

            location /static/ {
                alias /opt/netbox-static/;
            }

            location / {
                proxy_pass http://netbox;
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Host $http_host;
                proxy_connect_timeout 300s;
                proxy_send_timeout 300s;
                proxy_read_timeout 300s;
            }
        }
        EOF'
      changed_when: false

    - name: Enable NetBox site
      ansible.builtin.command: pct exec 103 -- ln -sf /etc/nginx/sites-available/netbox /etc/nginx/sites-enabled/netbox
      changed_when: false

    - name: Disable default site
      ansible.builtin.command: pct exec 103 -- rm -f /etc/nginx/sites-enabled/default
      changed_when: false

    - name: Test Nginx configuration
      ansible.builtin.command: pct exec 103 -- nginx -t
      changed_when: false

    - name: Restart Nginx
      ansible.builtin.command: pct exec 103 -- systemctl restart nginx
      changed_when: false

    - name: Enable Nginx on boot
      ansible.builtin.command: pct exec 103 -- systemctl enable nginx
      changed_when: false

    - name: Wait for Nginx to be ready
      ansible.builtin.wait_for:
        timeout: 10

    - name: Get proxy container IP
      ansible.builtin.shell: >
        pct exec 103 -- ip -4 addr show eth0 | grep inet | awk '{print $2}' | cut -d/ -f1
      register: complete_proxy_ip
      changed_when: false

    - name: Display access information
      ansible.builtin.debug:
        msg:
          - "=================================="
          - "NetBox Deployment Complete!"
          - "=================================="
          - ""
          - "Access URL: https://{{ complete_proxy_ip.stdout }}"
          - "Username: admin"
          - "Password: NetBox2024!"
          - ""
          - "Note: Self-signed certificate in use"
          - "Your browser will show a security warning"
          - "=================================="
