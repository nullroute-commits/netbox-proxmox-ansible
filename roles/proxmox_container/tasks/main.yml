---
# roles/proxmox_container/tasks/main.yml
# Uses proxmox_container_item variable (passed from playbook) for container configuration

- name: Check if container exists
  ansible.builtin.command: pct status {{ proxmox_container_item.vmid }}
  register: proxmox_container_status
  failed_when: false
  changed_when: false

- name: Create container
  ansible.builtin.command: >
    pct create {{ proxmox_container_item.vmid }}
    {{ proxmox_container_template_storage }}:vztmpl/{{ proxmox_container_template | default(debian_template) }}
    --hostname {{ proxmox_container_item.hostname }}
    --cores {{ proxmox_container_item.cpu | default(proxmox_container_default_cores) }}
    --memory {{ proxmox_container_item.memory | default(proxmox_container_default_memory) }}
    --swap {{ proxmox_container_item.swap | default(proxmox_container_default_swap) }}
    --rootfs {{ proxmox_container_storage }}:{{ proxmox_container_item.disk | default(proxmox_container_default_disk) }}
    --unprivileged {{ 1 if proxmox_container_unprivileged else 0 }}
    --features nesting=1
    --onboot {{ 1 if proxmox_container_onboot else 0 }}
    --start 0
    --password {{ vault_container_root_password }}
    --ostype {{ proxmox_container_ostype }}
  when: proxmox_container_status.rc != 0
  changed_when: true

- name: Configure network interfaces for container
  when: proxmox_container_status.rc != 0
  block:
    - name: Add backend network interface (eth0)
      ansible.builtin.command: >
        pct set {{ proxmox_container_item.vmid }}
        --net0 name={{ proxmox_container_net0_name }},bridge={{ backend_network.name }},ip={{ proxmox_container_item.backend_ip }}/24,gw={{ backend_network.gateway }}
      when: proxmox_container_item.backend_ip is defined
      changed_when: true

    - name: Add DMZ network interface (eth1)
      ansible.builtin.command: >
        pct set {{ proxmox_container_item.vmid }}
        --net1 name={{ proxmox_container_net1_name }},bridge={{ dmz_network.name }},ip={{ proxmox_container_item.dmz_ip }}/24,gw={{ dmz_network.gateway }}
      when: proxmox_container_item.dmz_ip is defined
      changed_when: true

    - name: Add external network interface (eth0)
      ansible.builtin.command: >
        pct set {{ proxmox_container_item.vmid }}
        --net0 name={{ proxmox_container_net0_name }},bridge={{ external_network.name }},ip=dhcp
      when:
        - proxmox_container_item.backend_ip is not defined
        - proxmox_container_item.dmz_ip is not defined
      changed_when: true

- name: Start container
  ansible.builtin.command: pct start {{ proxmox_container_item.vmid }}
  when: proxmox_container_status.rc != 0
  changed_when: true

- name: Wait for container to be ready
  ansible.builtin.wait_for:
    timeout: "{{ proxmox_container_wait_timeout }}"
  when: proxmox_container_status.rc != 0

- name: Create network interfaces file for container
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      pct exec {{ proxmox_container_item.vmid }} -- bash -c 'cat > /etc/network/interfaces << EOF
      auto lo
      iface lo inet loopback

      {% if proxmox_container_item.backend_ip is defined %}
      auto eth0
      iface eth0 inet static
          address {{ proxmox_container_item.backend_ip }}
          netmask 255.255.255.0
          gateway {{ backend_network.gateway }}
      {% endif %}

      {% if proxmox_container_item.dmz_ip is defined %}
      auto eth1
      iface eth1 inet static
          address {{ proxmox_container_item.dmz_ip }}
          netmask 255.255.255.0
          {% if proxmox_container_item.backend_ip is not defined %}
          gateway {{ dmz_network.gateway }}
          {% endif %}
      {% endif %}
      EOF'
    executable: /bin/bash
  when: proxmox_container_status.rc != 0
  changed_when: true

- name: Restart networking in container
  ansible.builtin.command: pct exec {{ proxmox_container_item.vmid }} -- systemctl restart networking
  when: proxmox_container_status.rc != 0
  failed_when: false
  changed_when: true

- name: Display container info
  ansible.builtin.debug:
    msg:
      - "Container {{ proxmox_container_item.hostname }} ({{ proxmox_container_item.vmid }}) configured"
      - "Backend IP: {{ proxmox_container_item.backend_ip | default('N/A') }}"
      - "DMZ IP: {{ proxmox_container_item.dmz_ip | default('N/A') }}"
