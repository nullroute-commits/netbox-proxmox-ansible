---
# roles/debian_base/tasks/main.yml

- name: Update apt cache
  ansible.builtin.command: pct exec {{ container.vmid }} -- apt update
  changed_when: false

- name: Install base packages
  ansible.builtin.command: pct exec {{ container.vmid }} -- apt install -y {{ item }}
  loop: "{{ debian_base_packages }}"
  register: debian_base_apt_install
  changed_when: "'0 newly installed' not in debian_base_apt_install.stdout"

- name: Generate locales
  ansible.builtin.command: >
    pct exec {{ container.vmid }} -- bash -c
    "echo '{{ debian_base_locale }} UTF-8' > /etc/locale.gen && locale-gen"
  changed_when: false

- name: Set timezone
  ansible.builtin.command: >
    pct exec {{ container.vmid }} -- ln -sf /usr/share/zoneinfo/{{ debian_base_timezone }} /etc/localtime
  changed_when: false
  failed_when: false

- name: Configure DNS
  ansible.builtin.command: >
    pct exec {{ container.vmid }} -- bash -c
    "echo 'nameserver {{ debian_base_nameservers[0] }}' > /etc/resolv.conf"
  changed_when: false

- name: Test internet connectivity
  ansible.builtin.command: pct exec {{ container.vmid }} -- ping -c 2 8.8.8.8
  register: debian_base_ping_result
  changed_when: false
  failed_when: false
  when: debian_base_test_connectivity | default(true)

- name: Display connectivity status
  ansible.builtin.debug:
    msg: "Internet connectivity: {{ 'OK' if debian_base_ping_result.rc == 0 else 'FAILED' }}"
  when: debian_base_test_connectivity | default(true)
