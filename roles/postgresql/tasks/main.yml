---
# roles/postgresql/tasks/main.yml

- name: Install PostgreSQL {{ postgresql_version }}
  command: pct exec {{ container.vmid }} -- apt install -y postgresql-{{ postgresql_version }} postgresql-client-{{ postgresql_version }}
  register: pg_install
  changed_when: "'0 newly installed' not in pg_install.stdout"

- name: Configure PostgreSQL to listen on all addresses
  command: pct exec {{ container.vmid }} -- bash -c "sed -i \"s/#listen_addresses = 'localhost'/listen_addresses = '*'/g\" /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf"
  changed_when: false

- name: Configure PostgreSQL max connections
  command: pct exec {{ container.vmid }} -- bash -c "sed -i 's/max_connections = 100/max_connections = 200/g' /etc/postgresql/{{ postgresql_version }}/main/postgresql.conf"
  changed_when: false

- name: Add pg_hba.conf entry for NetBox
  command: pct exec {{ container.vmid }} -- bash -c "echo 'host    all    all    {{ backend_network.cidr }}    md5' >> /etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf"
  changed_when: false

- name: Restart PostgreSQL
  command: pct exec {{ container.vmid }} -- systemctl restart postgresql
  changed_when: false

- name: Wait for PostgreSQL to be ready
  command: pct exec {{ container.vmid }} -- pg_isready
  register: pg_ready
  until: pg_ready.rc == 0
  retries: 10
  delay: 2
  changed_when: false

- name: Create NetBox database
  command: pct exec {{ container.vmid }} -- sudo -u postgres psql -c "CREATE DATABASE netbox;"
  register: db_create
  changed_when: "'CREATE DATABASE' in db_create.stdout"
  failed_when: 
    - db_create.rc != 0
    - "'already exists' not in db_create.stderr"

- name: Create NetBox database user
  command: pct exec {{ container.vmid }} -- sudo -u postgres psql -c "CREATE USER netbox WITH PASSWORD '{{ vault_netbox_db_password }}';"
  register: user_create
  changed_when: "'CREATE ROLE' in user_create.stdout"
  failed_when:
    - user_create.rc != 0
    - "'already exists' not in user_create.stderr"

- name: Grant privileges to NetBox user
  command: pct exec {{ container.vmid }} -- sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE netbox TO netbox;"
  changed_when: false

- name: Grant schema privileges
  command: pct exec {{ container.vmid }} -- sudo -u postgres psql -d netbox -c "GRANT ALL ON SCHEMA public TO netbox;"
  changed_when: false

- name: Display PostgreSQL status
  debug:
    msg:
      - "PostgreSQL {{ postgresql_full_version }} installed and configured"
      - "Database: netbox"
      - "User: netbox"
      - "Listening on: *:5432"
