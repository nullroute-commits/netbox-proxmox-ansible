---
# roles/nginx_proxy/tasks/main.yml

- name: Install Nginx and OpenSSL
  command: pct exec {{ container.vmid }} -- apt install -y nginx openssl
  register: nginx_install
  changed_when: "'0 newly installed' not in nginx_install.stdout"

- name: Create SSL directory
  command: pct exec {{ container.vmid }} -- mkdir -p /etc/nginx/ssl
  changed_when: false

- name: Generate self-signed SSL certificate
  command: >
    pct exec {{ container.vmid }} -- openssl req -x509 -nodes -days 365 -newkey rsa:4096
    -keyout /etc/nginx/ssl/netbox.key
    -out /etc/nginx/ssl/netbox.crt
    -subj "/C=US/ST=State/L=City/O=Organization/CN=netbox.local"
  args:
    creates: /etc/nginx/ssl/netbox.crt
  changed_when: false
  failed_when: false

- name: Set permissions on SSL key
  command: pct exec {{ container.vmid }} -- chmod 600 /etc/nginx/ssl/netbox.key
  changed_when: false

- name: Template Nginx configuration
  shell: |
    pct exec {{ container.vmid }} -- bash -c 'cat > /etc/nginx/sites-available/netbox << "EOF"
    upstream netbox {
        server {{ containers.application.dmz_ip }}:8000;
    }

    server {
        listen 80;
        server_name _;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        
        server_name _;

        ssl_certificate /etc/nginx/ssl/netbox.crt;
        ssl_certificate_key /etc/nginx/ssl/netbox.key;
        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        client_max_body_size 25m;

        location /static/ {
            proxy_pass http://netbox/static/;
            proxy_set_header Host $http_host;
        }

        location / {
            proxy_pass http://netbox;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
            
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
            
            proxy_buffering off;
            proxy_request_buffering off;
        }

        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-XSS-Protection "1; mode=block";
    }
    EOF'
  changed_when: false

- name: Enable NetBox site
  command: pct exec {{ container.vmid }} -- ln -sf /etc/nginx/sites-available/netbox /etc/nginx/sites-enabled/netbox
  changed_when: false
  failed_when: false

- name: Disable default site
  command: pct exec {{ container.vmid }} -- rm -f /etc/nginx/sites-enabled/default
  changed_when: false
  failed_when: false

- name: Test Nginx configuration
  command: pct exec {{ container.vmid }} -- nginx -t
  changed_when: false

- name: Restart Nginx
  command: pct exec {{ container.vmid }} -- systemctl restart nginx
  changed_when: false

- name: Enable Nginx service
  command: pct exec {{ container.vmid }} -- systemctl enable nginx
  changed_when: false
