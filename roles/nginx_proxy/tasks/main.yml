---
# roles/nginx_proxy/tasks/main.yml

- name: Install Nginx and OpenSSL
  ansible.builtin.command: >
    pct exec {{ container.vmid }} -- apt install -y {{ nginx_proxy_packages | join(' ') }}
  register: nginx_proxy_install
  changed_when: "'0 newly installed' not in nginx_proxy_install.stdout"

- name: Create SSL directory
  ansible.builtin.command: pct exec {{ container.vmid }} -- mkdir -p {{ nginx_proxy_ssl_dir }}
  changed_when: false

- name: Generate self-signed SSL certificate
  ansible.builtin.command: >
    pct exec {{ container.vmid }} -- openssl req -x509 -nodes
    -days {{ nginx_proxy_ssl_days }}
    -newkey rsa:{{ nginx_proxy_ssl_key_size }}
    -keyout {{ nginx_proxy_ssl_key }}
    -out {{ nginx_proxy_ssl_cert }}
    -subj "{{ nginx_proxy_ssl_subject }}"
  args:
    creates: "{{ nginx_proxy_ssl_cert }}"
  changed_when: false
  failed_when: false

- name: Set permissions on SSL key
  ansible.builtin.command: pct exec {{ container.vmid }} -- chmod 600 {{ nginx_proxy_ssl_key }}
  changed_when: false

- name: Template Nginx configuration
  ansible.builtin.shell: |
    pct exec {{ container.vmid }} -- bash -c 'cat > {{ nginx_proxy_sites_available }}/{{ nginx_proxy_site_name }} << "EOF"
    upstream {{ nginx_proxy_upstream_name }} {
        server {{ containers.application.dmz_ip }}:8000;
    }

    server {
        listen 80;
        server_name {{ nginx_proxy_server_name }};
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;

        server_name {{ nginx_proxy_server_name }};

        ssl_certificate {{ nginx_proxy_ssl_cert }};
        ssl_certificate_key {{ nginx_proxy_ssl_key }};

        ssl_protocols {{ nginx_proxy_ssl_protocols }};
        ssl_ciphers {{ nginx_proxy_ssl_ciphers }};
        ssl_prefer_server_ciphers {{ nginx_proxy_ssl_prefer_server_ciphers | ternary('on', 'off') }};
        ssl_session_cache {{ nginx_proxy_ssl_session_cache }};
        ssl_session_timeout {{ nginx_proxy_ssl_session_timeout }};

        client_max_body_size {{ nginx_proxy_client_max_body_size }};

        location /static/ {
            proxy_pass http://{{ nginx_proxy_upstream_name }}/static/;
            proxy_set_header Host $http_host;
        }

        location / {
            proxy_pass http://{{ nginx_proxy_upstream_name }};
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $http_host;

            proxy_connect_timeout {{ nginx_proxy_connect_timeout }};
            proxy_send_timeout {{ nginx_proxy_send_timeout }};
            proxy_read_timeout {{ nginx_proxy_read_timeout }};

            proxy_buffering {{ nginx_proxy_buffering | ternary('on', 'off') }};
            proxy_request_buffering {{ nginx_proxy_request_buffering | ternary('on', 'off') }};
        }

        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-XSS-Protection "1; mode=block";
    }
    EOF'
  changed_when: false

- name: Enable NetBox site
  ansible.builtin.command: >
    pct exec {{ container.vmid }} -- ln -sf
    {{ nginx_proxy_sites_available }}/{{ nginx_proxy_site_name }}
    {{ nginx_proxy_sites_enabled }}/{{ nginx_proxy_site_name }}
  changed_when: false
  failed_when: false

- name: Disable default site
  ansible.builtin.command: pct exec {{ container.vmid }} -- rm -f {{ nginx_proxy_sites_enabled }}/default
  changed_when: false
  failed_when: false

- name: Test Nginx configuration
  ansible.builtin.command: pct exec {{ container.vmid }} -- nginx -t
  changed_when: false

- name: Restart Nginx
  ansible.builtin.command: pct exec {{ container.vmid }} -- systemctl restart nginx
  changed_when: false

- name: Enable Nginx service
  ansible.builtin.command: pct exec {{ container.vmid }} -- systemctl enable nginx
  changed_when: false
